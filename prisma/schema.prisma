generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ─── Enums ──────────────────────────────────────────────────────────────────

enum TenantStatus {
  ACTIVE
  SUSPENDED
  DEACTIVATED
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  COLLECTOR
}

enum LoanType {
  MONTHLY
  DAILY
}

enum LoanStatus {
  ACTIVE
  CLOSED
  DEFAULTED
  WRITTEN_OFF
  CANCELLED
}

enum TransactionType {
  DISBURSEMENT
  ADVANCE_INTEREST
  INTEREST_PAYMENT
  PRINCIPAL_RETURN
  DAILY_COLLECTION
  PENALTY
  GUARANTOR_PAYMENT
  INTEREST_WAIVER
  PENALTY_WAIVER
  OPENING_BALANCE
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PenaltyStatus {
  PENDING
  PARTIALLY_PAID
  PAID
  WAIVED
}

enum ExpenseCategory {
  TRAVEL
  SALARY
  OFFICE
  LEGAL
  MISC
}

enum FundEntryType {
  INJECTION
  WITHDRAWAL
}

// ─── Models ─────────────────────────────────────────────────────────────────

model Tenant {
  id                String       @id @default(uuid()) @db.Uuid
  name              String       @db.VarChar(200)
  slug              String       @unique @db.VarChar(50)
  ownerName         String       @map("owner_name") @db.VarChar(200)
  ownerPhone        String       @map("owner_phone") @db.VarChar(15)
  ownerEmail        String?      @map("owner_email") @db.VarChar(255)
  address           String?      @db.Text
  status            TenantStatus @default(ACTIVE)
  subscriptionPlan  String?      @map("subscription_plan") @db.VarChar(50)
  settings          Json         @default("{}")
  createdAt         DateTime     @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime     @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  users              User[]
  customers          Customer[]
  loans              Loan[]
  transactions       Transaction[]
  principalReturns   PrincipalReturn[]
  penalties          Penalty[]
  expenses           Expense[]
  fundEntries        FundEntry[]
  loanNumberSequences LoanNumberSequence[]
  idempotencyKeys    IdempotencyKey[]

  @@map("tenants")
}

model User {
  id           String   @id @default(uuid()) @db.Uuid
  tenantId     String?  @map("tenant_id") @db.Uuid
  name         String   @db.VarChar(100)
  phone        String   @db.VarChar(15)
  email        String?  @db.VarChar(255)
  passwordHash String   @map("password_hash") @db.VarChar(255)
  role         UserRole
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  tenant              Tenant?         @relation(fields: [tenantId], references: [id])
  refreshTokens       RefreshToken[]
  customersCreated    Customer[]      @relation("CustomerCreatedBy")
  loansCreated        Loan[]          @relation("LoanCreatedBy")
  loansDefaultedBy    Loan[]          @relation("LoanDefaultedBy")
  loansCancelledBy    Loan[]          @relation("LoanCancelledBy")
  loansWrittenOffBy   Loan[]          @relation("LoanWrittenOffBy")
  loansClosedBy       Loan[]          @relation("LoanClosedBy")
  transactionsCollected Transaction[] @relation("TransactionCollectedBy")
  transactionsApproved  Transaction[] @relation("TransactionApprovedBy")
  principalReturnsCreated PrincipalReturn[] @relation("PrincipalReturnCreatedBy")
  penaltiesCreated    Penalty[]       @relation("PenaltyCreatedBy")
  expensesCreated     Expense[]       @relation("ExpenseCreatedBy")
  fundEntriesCreated  FundEntry[]     @relation("FundEntryCreatedBy")
  idempotencyKeys     IdempotencyKey[]

  // Partial unique indexes for phone are added via raw SQL migration
  // (Prisma cannot express conditional/partial unique constraints)
  @@index([tenantId], map: "idx_users_tenant_id")
  @@map("users")
}

model Customer {
  id                 String   @id @default(uuid()) @db.Uuid
  tenantId           String   @map("tenant_id") @db.Uuid
  fullName           String   @map("full_name") @db.VarChar(200)
  phone              String   @db.VarChar(15)
  alternatePhone     String?  @map("alternate_phone") @db.VarChar(15)
  address            String?  @db.Text
  aadhaarNumber      String?  @map("aadhaar_number") @db.VarChar(12)
  panNumber          String?  @map("pan_number") @db.VarChar(10)
  idProofType        String?  @map("id_proof_type") @db.VarChar(50)
  idProofDocumentUrl String?  @map("id_proof_document_url") @db.VarChar(500)
  photoUrl           String?  @map("photo_url") @db.VarChar(500)
  occupation         String?  @db.VarChar(200)
  notes              String?  @db.Text
  isDefaulter        Boolean  @default(false) @map("is_defaulter")
  createdById        String   @map("created_by") @db.Uuid
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt          DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  tenant          Tenant @relation(fields: [tenantId], references: [id])
  createdBy       User   @relation("CustomerCreatedBy", fields: [createdById], references: [id])
  loansAsBorrower Loan[] @relation("LoanBorrower")
  loansAsGuarantor Loan[] @relation("LoanGuarantor")

  @@unique([tenantId, aadhaarNumber], map: "uq_customers_tenant_aadhaar")
  @@unique([tenantId, panNumber], map: "uq_customers_tenant_pan")
  @@index([tenantId, phone], map: "idx_customers_tenant_phone")
  @@index([tenantId, isDefaulter], map: "idx_customers_tenant_defaulter")
  @@map("customers")
}

model Loan {
  id                     String     @id @default(uuid()) @db.Uuid
  tenantId               String     @map("tenant_id") @db.Uuid
  loanNumber             String     @map("loan_number") @db.VarChar(20)
  borrowerId             String     @map("borrower_id") @db.Uuid
  loanType               LoanType   @map("loan_type")
  principalAmount        Decimal    @map("principal_amount") @db.Decimal(12, 2)
  interestRate           Decimal    @map("interest_rate") @db.Decimal(5, 2)
  disbursementDate       DateTime   @map("disbursement_date") @db.Date

  // Monthly loan fields
  expectedMonths         Int?       @map("expected_months")
  monthlyDueDay          Int?       @map("monthly_due_day")
  remainingPrincipal     Decimal?   @map("remaining_principal") @db.Decimal(12, 2)
  billingPrincipal       Decimal?   @map("billing_principal") @db.Decimal(12, 2)
  advanceInterestAmount  Decimal?   @map("advance_interest_amount") @db.Decimal(12, 2)
  lastInterestPaidThrough DateTime? @map("last_interest_paid_through") @db.Date

  // Daily loan fields
  termDays               Int?       @map("term_days")
  totalRepaymentAmount   Decimal?   @map("total_repayment_amount") @db.Decimal(12, 2)
  dailyPaymentAmount     Decimal?   @map("daily_payment_amount") @db.Decimal(12, 2)
  termEndDate            DateTime?  @map("term_end_date") @db.Date
  graceDays              Int        @default(7) @map("grace_days")
  totalCollected         Decimal    @default(0) @map("total_collected") @db.Decimal(12, 2)

  // Common fields
  status                 LoanStatus @default(ACTIVE)
  guarantorId            String?    @map("guarantor_id") @db.Uuid
  collateralDescription  String?    @map("collateral_description") @db.Text
  collateralEstimatedValue Decimal? @map("collateral_estimated_value") @db.Decimal(12, 2)
  closureDate            DateTime?  @map("closure_date") @db.Date
  isMigrated             Boolean    @default(false) @map("is_migrated")
  notes                  String?    @db.Text
  cancellationReason     String?    @map("cancellation_reason") @db.Text
  defaultedAt            DateTime?  @map("defaulted_at") @db.Timestamptz
  defaultedById          String?    @map("defaulted_by") @db.Uuid
  cancelledAt            DateTime?  @map("cancelled_at") @db.Timestamptz
  cancelledById          String?    @map("cancelled_by") @db.Uuid
  writtenOffAt           DateTime?  @map("written_off_at") @db.Timestamptz
  writtenOffById         String?    @map("written_off_by") @db.Uuid
  closedById             String?    @map("closed_by") @db.Uuid
  version                Int        @default(1)
  createdById            String     @map("created_by") @db.Uuid
  createdAt              DateTime   @default(now()) @map("created_at") @db.Timestamptz
  updatedAt              DateTime   @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  tenant         Tenant    @relation(fields: [tenantId], references: [id])
  borrower       Customer  @relation("LoanBorrower", fields: [borrowerId], references: [id])
  guarantor      Customer? @relation("LoanGuarantor", fields: [guarantorId], references: [id])
  createdBy      User      @relation("LoanCreatedBy", fields: [createdById], references: [id])
  defaultedBy    User?     @relation("LoanDefaultedBy", fields: [defaultedById], references: [id])
  cancelledBy    User?     @relation("LoanCancelledBy", fields: [cancelledById], references: [id])
  writtenOffBy   User?     @relation("LoanWrittenOffBy", fields: [writtenOffById], references: [id])
  closedBy       User?     @relation("LoanClosedBy", fields: [closedById], references: [id])
  transactions   Transaction[]
  principalReturns PrincipalReturn[]
  penalties      Penalty[]

  @@unique([tenantId, loanNumber], map: "uq_loans_tenant_loan_number")
  @@index([tenantId, borrowerId], map: "idx_loans_tenant_borrower")
  @@index([tenantId, guarantorId], map: "idx_loans_tenant_guarantor")
  @@index([tenantId, status], map: "idx_loans_tenant_status")
  @@index([tenantId, loanType], map: "idx_loans_tenant_type")
  @@index([tenantId, termEndDate], map: "idx_loans_tenant_term_end")
  @@index([tenantId, disbursementDate], map: "idx_loans_tenant_disbursement")
  @@map("loans")
}

model Transaction {
  id                     String          @id @default(uuid()) @db.Uuid
  tenantId               String          @map("tenant_id") @db.Uuid
  loanId                 String          @map("loan_id") @db.Uuid
  penaltyId              String?         @map("penalty_id") @db.Uuid
  correctedTransactionId String?         @map("corrected_transaction_id") @db.Uuid
  transactionType        TransactionType @map("transaction_type")
  amount                 Decimal         @db.Decimal(12, 2)
  transactionDate        DateTime        @map("transaction_date") @db.Date
  effectiveDate          DateTime?       @map("effective_date") @db.Date
  collectedById          String?         @map("collected_by") @db.Uuid
  approvalStatus         ApprovalStatus  @default(APPROVED) @map("approval_status")
  approvedById           String?         @map("approved_by") @db.Uuid
  approvedAt             DateTime?       @map("approved_at") @db.Timestamptz
  rejectionReason        String?         @map("rejection_reason") @db.Text
  notes                  String?         @db.Text
  createdAt              DateTime        @default(now()) @map("created_at") @db.Timestamptz
  updatedAt              DateTime        @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  tenant               Tenant       @relation(fields: [tenantId], references: [id])
  loan                 Loan         @relation(fields: [loanId], references: [id])
  penalty              Penalty?     @relation(fields: [penaltyId], references: [id])
  correctedTransaction Transaction? @relation("TransactionCorrection", fields: [correctedTransactionId], references: [id])
  corrections          Transaction[] @relation("TransactionCorrection")
  collectedBy          User?        @relation("TransactionCollectedBy", fields: [collectedById], references: [id])
  approvedBy           User?        @relation("TransactionApprovedBy", fields: [approvedById], references: [id])
  principalReturn      PrincipalReturn?

  @@index([tenantId, loanId], map: "idx_txn_tenant_loan")
  @@index([tenantId, transactionDate], map: "idx_txn_tenant_date")
  @@index([tenantId, transactionType], map: "idx_txn_tenant_type")
  @@index([tenantId, approvalStatus], map: "idx_txn_tenant_approval")
  @@index([tenantId, collectedById], map: "idx_txn_tenant_collector")
  @@map("transactions")
}

model PrincipalReturn {
  id                      String   @id @default(uuid()) @db.Uuid
  tenantId                String   @map("tenant_id") @db.Uuid
  loanId                  String   @map("loan_id") @db.Uuid
  transactionId           String   @unique @map("transaction_id") @db.Uuid
  amountReturned          Decimal  @map("amount_returned") @db.Decimal(12, 2)
  remainingPrincipalAfter Decimal  @map("remaining_principal_after") @db.Decimal(12, 2)
  returnDate              DateTime @map("return_date") @db.Date
  notes                   String?  @db.Text
  createdById             String   @map("created_by") @db.Uuid
  createdAt               DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  tenant      Tenant      @relation(fields: [tenantId], references: [id])
  loan        Loan        @relation(fields: [loanId], references: [id])
  transaction Transaction @relation(fields: [transactionId], references: [id])
  createdBy   User        @relation("PrincipalReturnCreatedBy", fields: [createdById], references: [id])

  @@map("principal_returns")
}

model Penalty {
  id              String        @id @default(uuid()) @db.Uuid
  tenantId        String        @map("tenant_id") @db.Uuid
  loanId          String        @map("loan_id") @db.Uuid
  daysOverdue     Int           @map("days_overdue")
  monthsCharged   Int           @map("months_charged")
  penaltyAmount   Decimal       @map("penalty_amount") @db.Decimal(12, 2)
  waivedAmount    Decimal       @default(0) @map("waived_amount") @db.Decimal(12, 2)
  netPayable      Decimal       @map("net_payable") @db.Decimal(12, 2)
  imposedDate     DateTime      @map("imposed_date") @db.Date
  status          PenaltyStatus @default(PENDING)
  amountCollected Decimal       @default(0) @map("amount_collected") @db.Decimal(12, 2)
  notes           String?       @db.Text
  createdById     String        @map("created_by") @db.Uuid
  createdAt       DateTime      @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime      @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  tenant       Tenant        @relation(fields: [tenantId], references: [id])
  loan         Loan          @relation(fields: [loanId], references: [id])
  createdBy    User          @relation("PenaltyCreatedBy", fields: [createdById], references: [id])
  transactions Transaction[]

  @@map("penalties")
}

model Expense {
  id          String          @id @default(uuid()) @db.Uuid
  tenantId    String          @map("tenant_id") @db.Uuid
  category    ExpenseCategory
  amount      Decimal         @db.Decimal(12, 2)
  description String?         @db.Text
  expenseDate DateTime        @map("expense_date") @db.Date
  isDeleted   Boolean         @default(false) @map("is_deleted")
  createdById String          @map("created_by") @db.Uuid
  createdAt   DateTime        @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime        @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  tenant    Tenant @relation(fields: [tenantId], references: [id])
  createdBy User   @relation("ExpenseCreatedBy", fields: [createdById], references: [id])

  @@map("expenses")
}

model FundEntry {
  id          String        @id @default(uuid()) @db.Uuid
  tenantId    String        @map("tenant_id") @db.Uuid
  entryType   FundEntryType @map("entry_type")
  amount      Decimal       @db.Decimal(12, 2)
  description String?       @db.Text
  entryDate   DateTime      @map("entry_date") @db.Date
  createdById String        @map("created_by") @db.Uuid
  createdAt   DateTime      @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  tenant    Tenant @relation(fields: [tenantId], references: [id])
  createdBy User   @relation("FundEntryCreatedBy", fields: [createdById], references: [id])

  @@map("fund_entries")
}

model RefreshToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  tokenHash String   @map("token_hash") @db.VarChar(255)
  expiresAt DateTime @map("expires_at") @db.Timestamptz
  isRevoked Boolean  @default(false) @map("is_revoked")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@index([userId], map: "idx_refresh_tokens_user")
  @@index([tokenHash], map: "idx_refresh_tokens_hash")
  @@map("refresh_tokens")
}

model LoanNumberSequence {
  tenantId     String   @map("tenant_id") @db.Uuid
  year         Int
  loanType     LoanType @map("loan_type")
  currentValue Int      @default(0) @map("current_value")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@id([tenantId, year, loanType])
  @@map("loan_number_sequences")
}

model IdempotencyKey {
  key            String   @id @db.VarChar(255)
  tenantId       String   @map("tenant_id") @db.Uuid
  userId         String   @map("user_id") @db.Uuid
  responseStatus Int      @map("response_status")
  responseBody   Json     @map("response_body")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz
  expiresAt      DateTime @map("expires_at") @db.Timestamptz

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  @@map("idempotency_keys")
}
